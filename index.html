<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è£åˆ‡å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #666;
            font-size: 16px;
        }

        .upload-text span {
            color: #667eea;
            font-weight: 600;
        }

        .upload-hint {
            color: #999;
            font-size: 13px;
            margin-top: 10px;
        }

        #fileInput {
            display: none;
        }

        .original-preview {
            margin-top: 20px;
            text-align: center;
        }

        .original-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .image-info {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .input-group {
            flex: 1;
            min-width: 250px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 6px;
            line-height: 1.5;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .result-item {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 15px;
            position: relative;
        }

        /* è£åˆ‡é¢„è§ˆå®¹å™¨ - å›ºå®šé«˜åº¦çš„è§†çª— */
        .crop-preview-container {
            position: relative;
            width: 100%;
            user-select: none;
            overflow: hidden;
            border-radius: 8px;
            background: #333;
            cursor: grab;
        }

        .crop-preview-container.dragging {
            cursor: grabbing;
        }

        /* å®Œæ•´åŸå›¾ */
        .crop-preview-container .full-image {
            width: 100%;
            display: block;
            pointer-events: none;
            position: relative;
        }

        /* è’™ç‰ˆå±‚ */
        .mask-overlay {
            position: absolute;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
            pointer-events: none;
            z-index: 5;
        }

        .mask-top {
            top: 0;
        }

        .mask-bottom {
            bottom: 0;
        }

        /* æœ‰æ•ˆåŒºåŸŸè¾¹æ¡† */
        .active-region-border {
            position: absolute;
            left: 0;
            right: 0;
            border: 2px dashed #38ef7d;
            pointer-events: none;
            box-shadow: 0 0 0 1px rgba(56, 239, 125, 0.3);
            z-index: 6;
        }

        /* æ»‘å—æ‰‹æŸ„ */
        .crop-handle {
            position: absolute;
            left: 0;
            right: 0;
            height: 24px;
            cursor: ns-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .crop-handle::before {
            content: '';
            width: 60px;
            height: 6px;
            background: #38ef7d;
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        .crop-handle:hover::before {
            background: #2ecc71;
            transform: scaleX(1.1);
        }

        .crop-handle.top {
            top: 0;
            transform: translateY(-50%);
        }

        .crop-handle.bottom {
            bottom: 0;
            transform: translateY(50%);
        }

        /* è£åˆ‡ä¿¡æ¯æ˜¾ç¤º */
        .crop-info-overlay {
            position: absolute;
            right: 10px;
            background: rgba(56, 239, 125, 0.9);
            color: #000;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            pointer-events: none;
            white-space: nowrap;
            z-index: 8;
        }

        .crop-info-top {
            top: 8px;
        }

        .crop-info-bottom {
            bottom: 8px;
        }

        .result-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            flex-wrap: wrap;
            gap: 8px;
        }

        .result-info span {
            font-size: 13px;
            color: #666;
        }

        .result-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .btn-copy {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-copy:hover {
            background: #5a6fd6;
        }

        .btn-download {
            background: #11998e;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-download:hover {
            background: #0e8377;
        }

        .btn-reset {
            background: #ff6b6b;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-reset:hover {
            background: #ee5a5a;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .hidden {
            display: none !important;
        }

        .section-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-tab {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .mode-tab.active {
            border-color: #667eea;
            background: #f0f2ff;
            color: #667eea;
        }

        .mode-tab:hover:not(.active) {
            border-color: #ccc;
        }

        /* è°ƒèŠ‚æç¤º */
        .adjust-hint {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 8px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .controls {
                flex-direction: column;
            }

            .btn-group {
                width: 100%;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ å›¾ç‰‡è£åˆ‡å·¥å…·</h1>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="card">
            <h3 class="section-title">ä¸Šä¼ å›¾ç‰‡</h3>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <p class="upload-text">æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œï¼Œæˆ– <span>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span></p>
                <p class="upload-hint">ä¹Ÿå¯ä»¥ç›´æ¥ Ctrl+V / Cmd+V ç²˜è´´å›¾ç‰‡</p>
            </div>
            <input type="file" id="fileInput" accept="image/*">
            <div class="original-preview hidden" id="originalPreview">
                <img id="originalImage" src="" alt="åŸå›¾é¢„è§ˆ">
                <p class="image-info" id="imageInfo"></p>
            </div>
        </div>

        <!-- è£åˆ‡æ§åˆ¶ -->
        <div class="card" id="controlsCard">
            <h3 class="section-title">è£åˆ‡è®¾ç½®</h3>
            
            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="ratio">æ¯”ä¾‹è£åˆ‡</button>
                <button class="mode-tab" data-mode="pixel">åƒç´ è£åˆ‡</button>
            </div>

            <div class="controls">
                <div class="input-group">
                    <label for="cropInput">è£åˆ‡å‚æ•°</label>
                    <input type="text" id="cropInput" value="1:1:1" placeholder="ä¾‹å¦‚: 1:1:1 æˆ– 0px:40px:">
                    <p class="help-text" id="helpText">
                        <strong>æ¯”ä¾‹æ¨¡å¼ï¼š</strong>è¾“å…¥æ¯”ä¾‹å€¼ï¼Œç”¨å†’å·åˆ†éš”ã€‚å¦‚ 1:1:1 è¡¨ç¤ºä¸‰ç­‰åˆ†ï¼Œ1:2 è¡¨ç¤ºæŒ‰ 1:2 æ¯”ä¾‹åˆ‡ä¸¤å—<br>
                        <strong>åƒç´ æ¨¡å¼ï¼š</strong>è¾“å…¥åƒç´ å€¼ï¼Œå¦‚ 0px:40px åˆ‡å‡º 0-40pxï¼Œ0px:40px: è¡¨ç¤ºåˆ‡ä¸¤å—ï¼ˆç¬¬äºŒå—åˆ°åº•éƒ¨ï¼‰
                    </p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="previewBtn" disabled>
                        ğŸ‘ï¸ é¢„è§ˆ
                    </button>
                    <button class="btn btn-success" id="exportBtn" disabled>
                        ğŸ’¾ å¯¼å‡ºå…¨éƒ¨
                    </button>
                </div>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="card hidden" id="resultsCard">
            <div class="results-header">
                <h2>ğŸ“‹ è£åˆ‡ç»“æœ</h2>
                <span id="resultCount"></span>
            </div>
            <div class="results-grid" id="resultsGrid"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // å…¨å±€å˜é‡
        let originalImage = null;
        let originalImageDataUrl = null;
        let croppedImages = [];
        let currentMode = 'ratio';

        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const originalPreview = document.getElementById('originalPreview');
        const originalImageEl = document.getElementById('originalImage');
        const imageInfo = document.getElementById('imageInfo');
        const cropInput = document.getElementById('cropInput');
        const previewBtn = document.getElementById('previewBtn');
        const exportBtn = document.getElementById('exportBtn');
        const resultsCard = document.getElementById('resultsCard');
        const resultsGrid = document.getElementById('resultsGrid');
        const resultCount = document.getElementById('resultCount');
        const toast = document.getElementById('toast');
        const modeTabs = document.querySelectorAll('.mode-tab');
        const helpText = document.getElementById('helpText');

        // æ¨¡å¼åˆ‡æ¢
        modeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                modeTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentMode = tab.dataset.mode;
                updateHelpText();
                cropInput.value = '';
            });
        });

        function updateHelpText() {
            if (currentMode === 'ratio') {
                helpText.innerHTML = `
                    <strong>æ¯”ä¾‹æ¨¡å¼ï¼š</strong>è¾“å…¥æ¯”ä¾‹å€¼ï¼Œç”¨å†’å·åˆ†éš”ã€‚å¦‚ 1:1:1 è¡¨ç¤ºä¸‰ç­‰åˆ†ï¼Œ1:2 è¡¨ç¤ºæŒ‰ 1:2 æ¯”ä¾‹åˆ‡ä¸¤å—
                `;
                cropInput.placeholder = 'ä¾‹å¦‚: 1:1:1 æˆ– 1:2';
            } else {
                helpText.innerHTML = `
                    <strong>åƒç´ æ¨¡å¼ï¼š</strong>è¾“å…¥åƒç´ å€¼ï¼Œå¦‚ 0px:40px åˆ‡å‡º 0-40pxï¼Œ0px:40px: è¡¨ç¤ºåˆ‡ä¸¤å—ï¼ˆç¬¬äºŒå—åˆ°åº•éƒ¨ï¼‰
                `;
                cropInput.placeholder = 'ä¾‹å¦‚: 0px:40px æˆ– 0px:40px:100px';
            }
        }

        // ä¸Šä¼ åŒºåŸŸäº‹ä»¶
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageUpload(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImageUpload(file);
            }
        });

        // ç²˜è´´ä¸Šä¼ 
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;
            
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        handleImageUpload(file, 'ç²˜è´´çš„å›¾ç‰‡');
                    }
                    break;
                }
            }
        });

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(file, customName = null) {
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImageDataUrl = e.target.result;
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    originalImageEl.src = e.target.result;
                    originalPreview.classList.remove('hidden');
                    const displayName = customName || file.name;
                    imageInfo.textContent = `å°ºå¯¸: ${img.width} Ã— ${img.height} åƒç´  | æ–‡ä»¶å: ${displayName}`;
                    previewBtn.disabled = false;
                    showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼');
                    
                    // å¦‚æœæœ‰è£åˆ‡å‚æ•°ï¼Œè‡ªåŠ¨è§¦å‘é¢„è§ˆ
                    if (cropInput.value.trim()) {
                        setTimeout(() => previewBtn.click(), 100);
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // è§£æè£åˆ‡å‚æ•°
        function parseCropParams(input) {
            const parts = input.split(':').map(p => p.trim());
            
            if (currentMode === 'ratio') {
                const ratios = parts.map(p => parseFloat(p)).filter(n => !isNaN(n) && n > 0);
                if (ratios.length < 2) {
                    throw new Error('è¯·è¾“å…¥è‡³å°‘ä¸¤ä¸ªæ¯”ä¾‹å€¼ï¼Œå¦‚ 1:1 æˆ– 1:2:1');
                }
                return { type: 'ratio', values: ratios };
            } else {
                const pixels = [];
                let hasTrailingColon = input.endsWith(':');
                
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (part === '') {
                        if (i === parts.length - 1 && hasTrailingColon) {
                            pixels.push(null);
                        }
                        continue;
                    }
                    const match = part.match(/^(\d+)(px)?$/i);
                    if (match) {
                        pixels.push(parseInt(match[1]));
                    } else {
                        throw new Error(`æ— æ•ˆçš„åƒç´ å€¼: ${part}`);
                    }
                }
                
                if (pixels.length < 2) {
                    throw new Error('è¯·è¾“å…¥è‡³å°‘ä¸¤ä¸ªåƒç´ å€¼ï¼Œå¦‚ 0px:40px');
                }
                
                return { type: 'pixel', values: pixels };
            }
        }

        // è®¡ç®—è£åˆ‡åŒºåŸŸ
        function calculateCropRegions(params, imageHeight) {
            const regions = [];
            
            if (params.type === 'ratio') {
                const total = params.values.reduce((a, b) => a + b, 0);
                let currentY = 0;
                
                for (const ratio of params.values) {
                    const height = Math.round((ratio / total) * imageHeight);
                    regions.push({
                        y: currentY,
                        height: Math.min(height, imageHeight - currentY)
                    });
                    currentY += height;
                }
                
                if (regions.length > 0) {
                    regions[regions.length - 1].height = imageHeight - regions[regions.length - 1].y;
                }
            } else {
                const values = params.values;
                
                for (let i = 0; i < values.length - 1; i++) {
                    const startY = values[i];
                    let endY = values[i + 1];
                    
                    if (endY === null) {
                        endY = imageHeight;
                    }
                    
                    if (startY >= imageHeight) continue;
                    
                    regions.push({
                        y: startY,
                        height: Math.min(endY, imageHeight) - startY
                    });
                }
            }
            
            return regions.filter(r => r.height > 0);
        }

        // åˆ›å»ºå¯è°ƒèŠ‚çš„é¢„è§ˆé¡¹
        function createAdjustablePreviewItem(index, region) {
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.dataset.index = index;
            
            resultItem.innerHTML = `
                <div class="crop-preview-container" data-index="${index}">
                    <img class="full-image" src="${originalImageDataUrl}" alt="åŸå›¾" draggable="false">
                    <div class="mask-overlay mask-top" style="height: 0px;"></div>
                    <div class="mask-overlay mask-bottom" style="height: 0px;"></div>
                    <div class="active-region-border" style="top: 0px; bottom: 0px;"></div>
                    <div class="crop-handle top" data-handle="top"></div>
                    <div class="crop-handle bottom" data-handle="bottom"></div>
                    <div class="crop-info-overlay crop-info-top">Y: ${region.y}px</div>
                    <div class="crop-info-overlay crop-info-bottom">é«˜åº¦: ${region.height}px</div>
                </div>
                <p class="adjust-hint">â†•ï¸ æ‹–åŠ¨æ»‘å—è°ƒèŠ‚è¾¹ç•Œ | æ‹–åŠ¨å›¾ç‰‡ç§»åŠ¨è£åˆ‡ä½ç½®</p>
                <div class="result-info">
                    <span class="size-info">ç¬¬ ${index + 1} å— | é«˜åº¦: ${region.height}px</span>
                    <div class="result-actions">
                        <button class="btn-small btn-reset" data-index="${index}">ğŸ”„ é‡ç½®</button>
                        <button class="btn-small btn-copy" data-index="${index}">ğŸ“‹ å¤åˆ¶</button>
                        <button class="btn-small btn-download" data-index="${index}">ğŸ’¾ ä¸‹è½½</button>
                    </div>
                </div>
            `;
            
            return resultItem;
        }

        // åˆå§‹åŒ–æ‹–åŠ¨è°ƒèŠ‚åŠŸèƒ½
        function initDragHandlers(container, index) {
            const handles = container.querySelectorAll('.crop-handle');
            const fullImage = container.querySelector('.full-image');
            
            const imageData = croppedImages[index];
            
            let isDragging = false;
            let dragType = null;
            let startY = 0;
            let startValue = 0;
            
            // æ»‘å—æ‹–åŠ¨ - è°ƒæ•´è’™ç‰ˆ
            handles.forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    isDragging = true;
                    dragType = handle.dataset.handle;
                    startY = e.clientY;
                    startValue = dragType === 'top' ? imageData.cropY : (imageData.cropY + imageData.cropHeight);
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
                
                handle.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    isDragging = true;
                    dragType = handle.dataset.handle;
                    startY = e.touches[0].clientY;
                    startValue = dragType === 'top' ? imageData.cropY : (imageData.cropY + imageData.cropHeight);
                    
                    document.addEventListener('touchmove', onTouchMove, { passive: false });
                    document.addEventListener('touchend', onTouchEnd);
                });
            });
            
            // å›¾ç‰‡åŒºåŸŸæ‹–åŠ¨ - ç§»åŠ¨åŸå›¾ä½ç½®
            container.addEventListener('mousedown', (e) => {
                if (e.target.closest('.crop-handle')) return;
                e.preventDefault();
                isDragging = true;
                dragType = 'image';
                startY = e.clientY;
                startValue = imageData.cropY;
                container.classList.add('dragging');
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            
            container.addEventListener('touchstart', (e) => {
                if (e.target.closest('.crop-handle')) return;
                e.preventDefault();
                isDragging = true;
                dragType = 'image';
                startY = e.touches[0].clientY;
                startValue = imageData.cropY;
                container.classList.add('dragging');
                
                document.addEventListener('touchmove', onTouchMove, { passive: false });
                document.addEventListener('touchend', onTouchEnd);
            });
            
            function onMouseMove(e) {
                if (!isDragging) return;
                handleMove(e.clientY);
            }
            
            function onTouchMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                handleMove(e.touches[0].clientY);
            }
            
            function handleMove(clientY) {
                const deltaY = clientY - startY;
                const scale = imageData.scale;
                const deltaPixels = deltaY * scale; // è½¬æ¢ä¸ºåŸå›¾åƒç´ 
                
                if (dragType === 'top') {
                    // æ‹–åŠ¨é¡¶éƒ¨æ»‘å— - æ”¹å˜è£åˆ‡èµ·å§‹ä½ç½®
                    let newCropY = startValue + deltaPixels;
                    newCropY = Math.max(0, Math.min(newCropY, imageData.cropY + imageData.cropHeight - 20 * scale));
                    const oldBottom = imageData.cropY + imageData.cropHeight;
                    imageData.cropY = newCropY;
                    imageData.cropHeight = oldBottom - newCropY;
                } else if (dragType === 'bottom') {
                    // æ‹–åŠ¨åº•éƒ¨æ»‘å— - æ”¹å˜è£åˆ‡ç»“æŸä½ç½®
                    let newBottom = startValue + deltaPixels;
                    newBottom = Math.max(imageData.cropY + 20 * scale, Math.min(newBottom, originalImage.height));
                    imageData.cropHeight = newBottom - imageData.cropY;
                } else if (dragType === 'image') {
                    // æ‹–åŠ¨å›¾ç‰‡ - ç§»åŠ¨è£åˆ‡åŒºåŸŸï¼ˆä¿æŒé«˜åº¦ä¸å˜ï¼‰
                    let newCropY = startValue - deltaPixels; // æ³¨æ„ï¼šå‘ä¸‹æ‹–å›¾ç‰‡ï¼Œè£åˆ‡åŒºåŸŸå‘ä¸Šç§»
                    newCropY = Math.max(0, Math.min(newCropY, originalImage.height - imageData.cropHeight));
                    imageData.cropY = newCropY;
                }
                
                updateDisplay(index);
            }
            
            function onMouseUp() {
                isDragging = false;
                dragType = null;
                container.classList.remove('dragging');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            function onTouchEnd() {
                isDragging = false;
                dragType = null;
                container.classList.remove('dragging');
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onTouchEnd);
            }
        }
        
        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay(index) {
            const imageData = croppedImages[index];
            const container = document.querySelector(`.crop-preview-container[data-index="${index}"]`);
            
            if (!container) return;
            
            const fullImage = container.querySelector('.full-image');
            const maskTop = container.querySelector('.mask-top');
            const maskBottom = container.querySelector('.mask-bottom');
            const activeRegionBorder = container.querySelector('.active-region-border');
            const infoTop = container.querySelector('.crop-info-top');
            const infoBottom = container.querySelector('.crop-info-bottom');
            const topHandle = container.querySelector('.crop-handle.top');
            const bottomHandle = container.querySelector('.crop-handle.bottom');
            
            const scale = imageData.scale;
            const displayWidth = container.offsetWidth;
            
            // è®¡ç®—æ˜¾ç¤ºä½ç½®
            const displayCropY = imageData.cropY / scale;
            const displayCropHeight = imageData.cropHeight / scale;
            const displayImageHeight = originalImage.height / scale;
            
            // è®¾ç½®å®¹å™¨é«˜åº¦ä¸ºè£åˆ‡åŒºåŸŸçš„æ˜¾ç¤ºé«˜åº¦
            container.style.height = displayCropHeight + 'px';
            
            // ç§»åŠ¨å›¾ç‰‡ï¼Œä½¿è£åˆ‡åŒºåŸŸå¯¹é½å®¹å™¨
            fullImage.style.transform = `translateY(${-displayCropY}px)`;
            
            // è’™ç‰ˆï¼ˆåœ¨å®¹å™¨å†…ï¼Œæ‰€ä»¥éƒ½æ˜¯0ï¼‰
            maskTop.style.height = '0px';
            maskBottom.style.height = '0px';
            
            // æœ‰æ•ˆåŒºåŸŸè¾¹æ¡†
            activeRegionBorder.style.top = '0px';
            activeRegionBorder.style.bottom = '0px';
            
            // æ»‘å—ä½ç½®
            topHandle.style.top = '0px';
            bottomHandle.style.bottom = '0px';
            
            // æ›´æ–°ä¿¡æ¯
            infoTop.textContent = `Y: ${Math.round(imageData.cropY)}px`;
            infoBottom.textContent = `é«˜åº¦: ${Math.round(imageData.cropHeight)}px`;
            
            // æ›´æ–°å°ºå¯¸ä¿¡æ¯
            const resultItem = container.closest('.result-item');
            const sizeInfo = resultItem.querySelector('.size-info');
            sizeInfo.textContent = `ç¬¬ ${index + 1} å— | Y: ${Math.round(imageData.cropY)}px, é«˜åº¦: ${Math.round(imageData.cropHeight)}px`;
        }
        
        // é‡ç½®è°ƒèŠ‚
        function resetAdjustment(index) {
            const imageData = croppedImages[index];
            
            imageData.cropY = imageData.originalRegion.y;
            imageData.cropHeight = imageData.originalRegion.height;
            
            updateDisplay(index);
            showToast('å·²é‡ç½®è£åˆ‡èŒƒå›´');
        }

        // é¢„è§ˆæŒ‰é’®ç‚¹å‡»
        previewBtn.addEventListener('click', () => {
            if (!originalImage) {
                showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }
            
            const input = cropInput.value.trim();
            if (!input) {
                showToast('è¯·è¾“å…¥è£åˆ‡å‚æ•°');
                return;
            }
            
            try {
                const params = parseCropParams(input);
                const regions = calculateCropRegions(params, originalImage.height);
                
                if (regions.length === 0) {
                    showToast('æ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„è£åˆ‡åŒºåŸŸ');
                    return;
                }
                
                croppedImages = [];
                resultsGrid.innerHTML = '';
                
                regions.forEach((region, index) => {
                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆåŸå›¾åƒç´  / æ˜¾ç¤ºåƒç´ ï¼‰
                    // å‡è®¾å®¹å™¨å®½åº¦çº¦ä¸º 320px
                    const containerWidth = 320;
                    const scale = originalImage.width / containerWidth;
                    
                    croppedImages.push({
                        originalRegion: { ...region },
                        cropY: region.y,
                        cropHeight: region.height,
                        scale: scale
                    });
                    
                    const resultItem = createAdjustablePreviewItem(index, region);
                    resultsGrid.appendChild(resultItem);
                });
                
                resultCount.textContent = `å…± ${regions.length} å—`;
                resultsCard.classList.remove('hidden');
                exportBtn.disabled = false;
                
                // ç­‰å¾… DOM æ›´æ–°ååˆå§‹åŒ–
                requestAnimationFrame(() => {
                    croppedImages.forEach((imageData, index) => {
                        const container = document.querySelector(`.crop-preview-container[data-index="${index}"]`);
                        if (container) {
                            // æ›´æ–°å®é™…ç¼©æ”¾æ¯”ä¾‹
                            const actualWidth = container.offsetWidth;
                            imageData.scale = originalImage.width / actualWidth;
                            
                            initDragHandlers(container, index);
                            updateDisplay(index);
                        }
                    });
                });
                
                showToast(`æˆåŠŸè£åˆ‡ä¸º ${regions.length} å—ï¼Œå¯æ‹–åŠ¨è°ƒèŠ‚`);
                
                setTimeout(() => {
                    resultsCard.scrollIntoView({ behavior: 'smooth' });
                }, 100);
                
            } catch (error) {
                showToast(error.message);
            }
        });

        // è·å–è°ƒæ•´åçš„å›¾ç‰‡
        function getAdjustedCanvas(index) {
            const imageData = croppedImages[index];
            
            const cropY = Math.round(imageData.cropY);
            const cropHeight = Math.round(imageData.cropHeight);
            
            if (cropHeight <= 0) return null;
            
            const canvas = document.createElement('canvas');
            canvas.width = originalImage.width;
            canvas.height = cropHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(
                originalImage,
                0, cropY, originalImage.width, cropHeight,
                0, 0, originalImage.width, cropHeight
            );
            
            return canvas;
        }

        // å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿
        async function copyImageToClipboard(index) {
            const canvas = getAdjustedCanvas(index);
            
            if (!canvas) {
                showToast('æœ‰æ•ˆåŒºåŸŸå¤ªå°ï¼Œæ— æ³•å¤åˆ¶');
                return;
            }
            
            try {
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/png');
                });
                
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);
                
                showToast('å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (error) {
                try {
                    const dataUrl = canvas.toDataURL('image/png');
                    await navigator.clipboard.writeText(dataUrl);
                    showToast('å·²å¤åˆ¶å›¾ç‰‡æ•°æ®ï¼ˆBase64ï¼‰');
                } catch (e) {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·å°è¯•å³é”®ä¿å­˜');
                }
            }
        }

        // ä¸‹è½½å•å¼ å›¾ç‰‡
        function downloadImage(index) {
            const canvas = getAdjustedCanvas(index);
            
            if (!canvas) {
                showToast('æœ‰æ•ˆåŒºåŸŸå¤ªå°ï¼Œæ— æ³•ä¸‹è½½');
                return;
            }
            
            const dataUrl = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `cropped_${index + 1}.png`;
            link.href = dataUrl;
            link.click();
        }

        // ç»“æœåŒºåŸŸäº‹ä»¶å§”æ‰˜
        resultsGrid.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('.btn-copy');
            const downloadBtn = e.target.closest('.btn-download');
            const resetBtn = e.target.closest('.btn-reset');
            
            if (copyBtn) {
                const index = parseInt(copyBtn.dataset.index);
                copyImageToClipboard(index);
            }
            
            if (downloadBtn) {
                const index = parseInt(downloadBtn.dataset.index);
                downloadImage(index);
            }
            
            if (resetBtn) {
                const index = parseInt(resetBtn.dataset.index);
                resetAdjustment(index);
            }
        });

        // å¯¼å‡ºå…¨éƒ¨
        exportBtn.addEventListener('click', () => {
            if (croppedImages.length === 0) {
                showToast('è¯·å…ˆé¢„è§ˆè£åˆ‡ç»“æœ');
                return;
            }
            
            let exportCount = 0;
            croppedImages.forEach((_, index) => {
                const canvas = getAdjustedCanvas(index);
                if (canvas) {
                    setTimeout(() => {
                        const dataUrl = canvas.toDataURL('image/png');
                        const link = document.createElement('a');
                        link.download = `cropped_${index + 1}.png`;
                        link.href = dataUrl;
                        link.click();
                    }, exportCount * 200);
                    exportCount++;
                }
            });
            
            showToast(`æ­£åœ¨å¯¼å‡º ${exportCount} å¼ å›¾ç‰‡...`);
        });

        // æ˜¾ç¤ºæç¤º
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // é”®ç›˜å¿«æ·é”®
        cropInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                previewBtn.click();
            }
        });
    </script>
</body>
</html>
